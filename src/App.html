<script type="text/babel">
/**
 * GAS環境用にリファクタリングされたReactアプリケーション
 * import/exportを削除し、単一ファイル構造化しています。
 */

const { useState, useEffect, useRef } = React;
// lucide-reactがUMDで正しくロードされない場合のフォールバック用にlucideオブジェクトを使用
// 注: CDN環境でのlucide-reactの挙動は不安定なため、ここではlucide-reactのグローバル変数を使用するか、
// 簡易的なアイコンラッパーを定義します。
const { 
  Calendar, Users, ClipboardList, Settings, LogOut, Menu, UserCircle, 
  ChevronLeft, ChevronRight, Save, Info, Play, Download, RefreshCw, X,
  Plus, Trash2, MapPin, Pencil, ShieldCheck, Stethoscope, AlertCircle
} = window.LucideReact || window.lucide; 

// --- Constants ---
const SHIFT_TYPES = [
  { id: 'S1', name: '早出', startTime: '07:00', endTime: '16:00', color: 'bg-orange-100', textColor: 'text-orange-800' },
  { id: 'S2', name: '日勤', startTime: '09:00', endTime: '18:00', color: 'bg-blue-100', textColor: 'text-blue-800' },
  { id: 'S3', name: '遅出', startTime: '11:00', endTime: '20:00', color: 'bg-green-100', textColor: 'text-green-800' },
  { id: 'S4', name: '夜勤', startTime: '16:30', endTime: '09:30', color: 'bg-purple-100', textColor: 'text-purple-800' },
  { id: 'S5', name: '休み', startTime: '-', endTime: '-', color: 'bg-slate-100', textColor: 'text-slate-500' },
];

const CURRENT_YEAR = 2023;
const CURRENT_MONTH = 11;

const INITIAL_REQUESTS = [
  { id: 'R001', staffId: 'U002', date: '2023-11-10', requestedShiftId: 'S5' },
  { id: 'R002', staffId: 'U002', date: '2023-11-11', requestedShiftId: 'S5' },
];

// --- Mock Data (GASサーバーから取得できない場合のフォールバック) ---
const MOCK_STAFF = [
  { id: 'U001', name: '佐藤 健一', group: ['1'], unit: 'さくら', role: 'リーダー', isQualified: true, employmentType: '常勤', isAdmin: true, password: 'admin' },
  { id: 'U002', name: '鈴木 花子', group: ['1'], unit: 'さくら', role: '職員', isQualified: true, employmentType: '常勤', isAdmin: false, password: 'user' },
];

const MOCK_EVENTS = [
  { id: 'E001', date: '2023-11-15', title: '避難訓練', group: ['1'], description: '14:00から実施' },
];

// --- Components ---

const Layout = ({ children, currentUser, currentView, setView, onLogout }) => {
  const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);

  const NavItem = ({ view, label, icon: Icon, adminOnly = false }) => {
    if (adminOnly && !currentUser?.isAdmin) return null;
    const isActive = currentView === view;
    return (
      <button
        onClick={() => {
          setView(view);
          setIsMobileMenuOpen(false);
        }}
        className={`flex items-center w-full px-4 py-3 text-sm font-medium transition-colors rounded-lg mb-1 ${
          isActive
            ? 'bg-teal-600 text-white shadow-md'
            : 'text-slate-600 hover:bg-slate-100 hover:text-teal-700'
        }`}
      >
        <Icon className="w-5 h-5 mr-3" />
        {label}
      </button>
    );
  };

  return (
    <div className="min-h-screen bg-slate-50 flex flex-col md:flex-row">
      <header className="md:hidden bg-white border-b p-4 flex justify-between items-center sticky top-0 z-20 shadow-sm">
        <h1 className="text-xl font-bold text-teal-700 flex items-center gap-2">
          <ClipboardList className="w-6 h-6" />
          ShiftCare AI
        </h1>
        <button onClick={() => setIsMobileMenuOpen(!isMobileMenuOpen)} className="p-2 text-slate-600">
          <Menu className="w-6 h-6" />
        </button>
      </header>

      <aside
        className={`fixed inset-y-0 left-0 z-10 w-64 bg-white border-r shadow-lg transform transition-transform duration-300 ease-in-out md:translate-x-0 md:static md:h-screen md:shadow-none ${
          isMobileMenuOpen ? 'translate-x-0' : '-translate-x-full'
        }`}
      >
        <div className="h-full flex flex-col">
          <div className="p-6 hidden md:block">
            <h1 className="text-2xl font-extrabold text-teal-700 flex items-center gap-2">
              <ClipboardList className="w-8 h-8" />
              ShiftCare AI
            </h1>
            <p className="text-xs text-slate-400 mt-1 pl-10">Smart Shift Management</p>
          </div>

          <div className="p-4 border-b md:border-none bg-slate-50 md:bg-transparent">
            <div className="flex items-center gap-3 px-2 py-2">
              <div className="bg-teal-100 p-2 rounded-full">
                <UserCircle className="w-6 h-6 text-teal-700" />
              </div>
              <div>
                <p className="text-sm font-bold text-slate-800">{currentUser?.name}</p>
                <p className="text-xs text-slate-500">{currentUser?.role} | {currentUser?.unit}</p>
              </div>
            </div>
          </div>

          <nav className="flex-1 px-4 py-4 overflow-y-auto">
            <NavItem view="REQUEST" label="シフト希望提出" icon={Calendar} />
            {currentUser?.isAdmin && (
              <>
                <div className="my-4 border-t border-slate-200"></div>
                <p className="px-4 text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2">管理者メニュー</p>
                <NavItem view="MANAGER" label="シフト作成・管理" icon={ClipboardList} adminOnly />
                <NavItem view="EVENTS" label="イベント管理" icon={Calendar} adminOnly />
                <NavItem view="STAFF" label="職員管理" icon={Users} adminOnly />
              </>
            )}
          </nav>

          <div className="p-4 border-t">
            <button
              onClick={onLogout}
              className="flex items-center w-full px-4 py-3 text-sm font-medium text-red-600 rounded-lg hover:bg-red-50 transition-colors"
            >
              <LogOut className="w-5 h-5 mr-3" />
              ログアウト
            </button>
          </div>
        </div>
      </aside>

      <main className="flex-1 p-4 md:p-8 overflow-y-auto h-[calc(100vh-64px)] md:h-screen">
        <div className="max-w-7xl mx-auto">
          {children}
        </div>
      </main>

      {isMobileMenuOpen && (
        <div 
          className="fixed inset-0 bg-black bg-opacity-50 z-0 md:hidden"
          onClick={() => setIsMobileMenuOpen(false)}
        ></div>
      )}
    </div>
  );
};

const Login = ({ onLogin, staffList }) => {
  const [selectedStaffId, setSelectedStaffId] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState('');

  const handleLogin = (e) => {
    e.preventDefault();
    const user = staffList.find(s => s.id === selectedStaffId);
    if (!user) {
      setError('職員を選択してください。');
      return;
    }
    if (user.password && user.password !== password) {
      setError('パスワードが間違っています。');
      return;
    }
    onLogin(user);
  };

  return (
    <div className="min-h-screen bg-slate-100 flex items-center justify-center p-4">
      <div className="bg-white rounded-2xl shadow-xl w-full max-w-md overflow-hidden">
        <div className="bg-teal-700 p-8 text-center">
          <div className="mx-auto bg-teal-600 w-16 h-16 rounded-full flex items-center justify-center mb-4 shadow-lg">
             <ClipboardList className="w-8 h-8 text-white" />
          </div>
          <h1 className="text-2xl font-bold text-white">ShiftCare AI</h1>
          <p className="text-teal-100 text-sm mt-1">介護シフト自動作成システム</p>
        </div>
        <div className="p-8">
          <form onSubmit={handleLogin} className="space-y-6">
            {error && (
              <div className="bg-red-50 border-l-4 border-red-500 p-4 rounded flex items-center">
                <AlertCircle className="w-5 h-5 text-red-500 mr-2" />
                <p className="text-sm text-red-700">{error}</p>
              </div>
            )}
            <div>
              <label className="block text-sm font-medium text-slate-700 mb-2">職員名</label>
              <select
                className="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-teal-500 focus:border-teal-500 outline-none transition-all bg-white"
                value={selectedStaffId}
                onChange={(e) => setSelectedStaffId(e.target.value)}
                required
              >
                <option value="">選択してください</option>
                {staffList.map(staff => (
                  <option key={staff.id} value={staff.id}>{staff.name} ({staff.role})</option>
                ))}
              </select>
            </div>
            <div>
              <label className="block text-sm font-medium text-slate-700 mb-2">パスワード</label>
              <input
                type="password"
                className="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-teal-500 focus:border-teal-500 outline-none transition-all"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                placeholder="パスワードを入力"
              />
            </div>
            <button type="submit" className="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-4 rounded-lg shadow transition-colors duration-200">
              ログイン
            </button>
          </form>
        </div>
      </div>
    </div>
  );
};

const ShiftRequestScreen = ({ currentUser, events, existingRequests, onSaveRequests }) => {
  const [requests, setRequests] = useState(existingRequests.filter(r => r.staffId === currentUser.id));
  const [note, setNote] = useState('');
  
  const daysInMonth = new Date(CURRENT_YEAR, CURRENT_MONTH, 0).getDate();
  const days = Array.from({ length: daysInMonth }, (_, i) => i + 1);

  const toggleRequest = (day) => {
    const dateStr = `${CURRENT_YEAR}-${String(CURRENT_MONTH).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    const existingIndex = requests.findIndex(r => r.date === dateStr);

    if (existingIndex >= 0) {
      const newRequests = [...requests];
      newRequests.splice(existingIndex, 1);
      setRequests(newRequests);
    } else {
      const newReq = {
        id: Math.random().toString(36).substr(2, 9),
        staffId: currentUser.id,
        date: dateStr,
        requestedShiftId: 'S5'
      };
      setRequests([...requests, newReq]);
    }
  };

  const handleSave = () => {
    onSaveRequests(requests);
    alert('希望を提出しました。');
  };

  return (
    <div className="space-y-6 animate-in fade-in duration-500">
      <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div>
          <h2 className="text-2xl font-bold text-slate-800 flex items-center gap-2">
            <Calendar className="text-teal-600" />
            {CURRENT_YEAR}年 {CURRENT_MONTH}月 シフト希望提出
          </h2>
          <p className="text-slate-500 mt-1">休みたい日付を選択してください。再度クリックすると解除されます。</p>
        </div>
        <button onClick={handleSave} className="flex items-center justify-center bg-teal-600 hover:bg-teal-700 text-white px-6 py-2.5 rounded-lg shadow-sm font-medium transition-all">
          <Save className="w-5 h-5 mr-2" />
          希望を提出する
        </button>
      </div>

      <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
        <div className="grid grid-cols-7 bg-slate-50 border-b">
          {['日', '月', '火', '水', '木', '金', '土'].map((day, i) => (
            <div key={day} className={`p-3 text-center text-sm font-bold ${i === 0 ? 'text-red-500' : i === 6 ? 'text-blue-500' : 'text-slate-600'}`}>
              {day}
            </div>
          ))}
        </div>
        <div className="grid grid-cols-7">
           {[0, 1, 2].map(pad => <div key={`pad-${pad}`} className="bg-slate-50/50 border-b border-r min-h-[100px]" />)}
           {days.map(day => {
             const dateStr = `${CURRENT_YEAR}-${String(CURRENT_MONTH).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
             const isRequested = requests.some(r => r.date === dateStr);
             const event = events.find(e => e.date === dateStr);
             const isWeekend = new Date(CURRENT_YEAR, CURRENT_MONTH - 1, day).getDay() === 0;

             return (
               <div key={day} onClick={() => toggleRequest(day)} className={`relative min-h-[100px] border-b border-r p-2 cursor-pointer transition-colors hover:bg-slate-50 ${isRequested ? 'bg-orange-50' : ''}`}>
                 <div className="flex justify-between items-start">
                   <span className={`text-sm font-semibold inline-block w-7 h-7 leading-7 text-center rounded-full ${isRequested ? 'bg-orange-500 text-white' : isWeekend ? 'text-red-500' : 'text-slate-700'}`}>
                     {day}
                   </span>
                   {isRequested && <span className="text-xs font-bold text-orange-600 bg-orange-100 px-1.5 py-0.5 rounded">休み希望</span>}
                 </div>
                 {event && (
                   <div className="mt-2 text-xs bg-blue-50 text-blue-700 border border-blue-100 p-1 rounded">
                     {event.title}
                   </div>
                 )}
               </div>
             );
           })}
        </div>
      </div>
      
      <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
        <h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center"><Info className="w-5 h-5 mr-2 text-teal-600" /> 特記事項</h3>
        <textarea
          className="w-full h-32 p-4 rounded-lg border border-slate-300 focus:ring-2 focus:ring-teal-500 outline-none resize-none"
          placeholder="その他、シフトに関する要望があれば記入してください"
          value={note}
          onChange={(e) => setNote(e.target.value)}
        ></textarea>
      </div>
    </div>
  );
};

const EventManager = ({ events, onUpdateEvents }) => {
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [newEvent, setNewEvent] = useState({ date: '', title: '', description: '', group: ['1'] });

  const handleDelete = (id) => {
    if (confirm('このイベントを削除してもよろしいですか？')) {
      onUpdateEvents(events.filter(e => e.id !== id));
    }
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    if (!newEvent.date || !newEvent.title) return;
    const event = {
      id: Math.random().toString(36).substr(2, 9),
      ...newEvent,
      description: newEvent.description || '',
      group: newEvent.group || ['1']
    };
    onUpdateEvents([...events, event].sort((a, b) => a.date.localeCompare(b.date)));
    setIsModalOpen(false);
    setNewEvent({ date: '', title: '', description: '', group: ['1'] });
  };

  return (
    <div className="space-y-6 animate-in fade-in duration-500">
      <div className="flex justify-between items-center">
        <div>
          <h2 className="text-2xl font-bold text-slate-800 flex items-center gap-2">
            <Calendar className="text-teal-600" /> イベント管理
          </h2>
          <p className="text-slate-500 mt-1">施設内の行事や予定を管理します。</p>
        </div>
        <button onClick={() => setIsModalOpen(true)} className="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-lg flex items-center shadow-sm transition-colors">
          <Plus className="w-5 h-5 mr-1" /> 新規イベント登録
        </button>
      </div>
      <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
        {events.map(event => (
          <div key={event.id} className="bg-white p-5 rounded-xl shadow-sm border border-slate-200 hover:shadow-md transition-shadow relative group">
            <button onClick={() => handleDelete(event.id)} className="absolute top-3 right-3 text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all">
              <Trash2 className="w-5 h-5" />
            </button>
            <div className="flex items-start justify-between mb-3">
              <div className="bg-blue-50 text-blue-700 px-3 py-1 rounded-lg text-sm font-bold">{event.date}</div>
            </div>
            <h3 className="text-lg font-bold text-slate-800 mb-2">{event.title}</h3>
            <p className="text-slate-600 text-sm mb-4 min-h-[40px]">{event.description || '詳細なし'}</p>
          </div>
        ))}
      </div>
      
      {isModalOpen && (
        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
          <div className="bg-white rounded-xl shadow-xl max-w-md w-full p-6 animate-in zoom-in-95 duration-200">
            <div className="flex justify-between items-center mb-4">
              <h3 className="font-bold text-slate-700">新規イベント登録</h3>
              <button onClick={() => setIsModalOpen(false)}><X className="w-5 h-5 text-slate-400" /></button>
            </div>
            <form onSubmit={handleSubmit} className="space-y-4">
              <div><label className="block text-sm font-medium mb-1">日付</label><input type="date" required className="w-full px-3 py-2 border rounded" value={newEvent.date} onChange={e => setNewEvent({ ...newEvent, date: e.target.value })} /></div>
              <div><label className="block text-sm font-medium mb-1">イベント名</label><input type="text" required className="w-full px-3 py-2 border rounded" value={newEvent.title} onChange={e => setNewEvent({ ...newEvent, title: e.target.value })} /></div>
              <div><label className="block text-sm font-medium mb-1">詳細</label><textarea className="w-full px-3 py-2 border rounded" value={newEvent.description} onChange={e => setNewEvent({ ...newEvent, description: e.target.value })} /></div>
              <div className="flex justify-end gap-3 pt-2">
                <button type="button" onClick={() => setIsModalOpen(false)} className="px-4 py-2 text-slate-600">キャンセル</button>
                <button type="submit" className="px-4 py-2 bg-teal-600 text-white rounded">登録する</button>
              </div>
            </form>
          </div>
        </div>
      )}
    </div>
  );
};

const StaffManager = ({ staffList, onUpdateStaff }) => {
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingId, setEditingId] = useState(null);
  const initialFormState = { id: '', name: '', role: '職員', unit: 'さくら', group: ['1'], employmentType: '常勤', isQualified: false, isAdmin: false, password: 'user' };
  const [formData, setFormData] = useState(initialFormState);

  const handleOpenModal = (staff) => {
    if (staff) {
      setEditingId(staff.id);
      setFormData({ ...staff });
    } else {
      setEditingId(null);
      setFormData({ ...initialFormState, id: Math.random().toString(36).substr(2, 9) });
    }
    setIsModalOpen(true);
  };

  const handleDelete = (id) => {
    if (confirm('この職員を削除してもよろしいですか？')) {
      onUpdateStaff(staffList.filter(s => s.id !== id));
    }
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    if (!formData.name) return;
    if (editingId) {
      onUpdateStaff(staffList.map(s => s.id === editingId ? formData : s));
    } else {
      onUpdateStaff([...staffList, formData]);
    }
    setIsModalOpen(false);
  };

  return (
    <div className="space-y-6 animate-in fade-in duration-500">
      <div className="flex justify-between items-center">
        <div>
          <h2 className="text-2xl font-bold text-slate-800 flex items-center gap-2"><Users className="text-teal-600" /> 職員管理</h2>
          <p className="text-slate-500 mt-1">職員情報の登録・編集・権限設定を行います。</p>
        </div>
        <button onClick={() => handleOpenModal()} className="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-lg flex items-center shadow-sm transition-colors">
          <Plus className="w-5 h-5 mr-1" /> 職員を追加
        </button>
      </div>
      <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
        <table className="w-full text-sm text-left">
          <thead className="bg-slate-50 text-slate-600 font-medium border-b">
            <tr>
              <th className="px-6 py-4">氏名 / ID</th>
              <th className="px-6 py-4">所属・役職</th>
              <th className="px-6 py-4">雇用形態</th>
              <th className="px-6 py-4">資格・権限</th>
              <th className="px-6 py-4 text-right">操作</th>
            </tr>
          </thead>
          <tbody className="divide-y divide-slate-100">
            {staffList.map(staff => (
              <tr key={staff.id} className="hover:bg-slate-50 transition-colors">
                <td className="px-6 py-4">
                  <div className="font-bold text-slate-800">{staff.name}</div>
                  <div className="text-xs text-slate-400">ID: {staff.id}</div>
                </td>
                <td className="px-6 py-4">
                  <div className="text-slate-700">{staff.unit}</div>
                  <div className="text-xs text-slate-500">{staff.role}</div>
                </td>
                <td className="px-6 py-4">
                  <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${staff.employmentType === '常勤' ? 'bg-green-100 text-green-800' : staff.employmentType === 'パート' ? 'bg-orange-100 text-orange-800' : 'bg-blue-100 text-blue-800'}`}>
                    {staff.employmentType}
                  </span>
                </td>
                <td className="px-6 py-4">
                  <div className="flex gap-2">
                    {staff.isQualified && <span className="inline-flex items-center px-2 py-1 rounded text-xs bg-purple-50 text-purple-700 border border-purple-100"><Stethoscope className="w-3 h-3 mr-1" />有資格</span>}
                    {staff.isAdmin && <span className="inline-flex items-center px-2 py-1 rounded text-xs bg-slate-100 text-slate-700 border border-slate-200"><ShieldCheck className="w-3 h-3 mr-1" />管理者</span>}
                  </div>
                </td>
                <td className="px-6 py-4 text-right">
                  <div className="flex justify-end gap-2">
                    <button onClick={() => handleOpenModal(staff)} className="p-2 text-slate-400 hover:text-teal-600"><Pencil className="w-4 h-4" /></button>
                    <button onClick={() => handleDelete(staff.id)} className="p-2 text-slate-400 hover:text-red-600"><Trash2 className="w-4 h-4" /></button>
                  </div>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
      
      {isModalOpen && (
        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
          <div className="bg-white rounded-xl shadow-xl max-w-2xl w-full p-6 animate-in zoom-in-95 duration-200 max-h-[90vh] overflow-y-auto">
             {/* 簡易フォーム実装 (詳細は省略) */}
             <div className="flex justify-between items-center mb-4">
               <h3 className="font-bold text-slate-700">{editingId ? '編集' : '新規登録'}</h3>
               <button onClick={() => setIsModalOpen(false)}><X className="w-5 h-5 text-slate-400" /></button>
             </div>
             <form onSubmit={handleSubmit} className="space-y-4">
               <div className="grid grid-cols-2 gap-4">
                 <div><label className="text-sm block">氏名</label><input type="text" className="w-full border p-2 rounded" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} required /></div>
                 <div><label className="text-sm block">役職</label><input type="text" className="w-full border p-2 rounded" value={formData.role} onChange={e => setFormData({...formData, role: e.target.value})} /></div>
               </div>
               <div className="flex gap-4">
                 <label className="flex items-center"><input type="checkbox" checked={formData.isQualified} onChange={e => setFormData({...formData, isQualified: e.target.checked})} className="mr-2" />資格あり</label>
                 <label className="flex items-center"><input type="checkbox" checked={formData.isAdmin} onChange={e => setFormData({...formData, isAdmin: e.target.checked})} className="mr-2" />管理者</label>
               </div>
               <div className="flex justify-end gap-2 pt-4">
                 <button type="button" onClick={() => setIsModalOpen(false)} className="px-4 py-2 border rounded">キャンセル</button>
                 <button type="submit" className="px-4 py-2 bg-teal-600 text-white rounded">保存</button>
               </div>
             </form>
          </div>
        </div>
      )}
    </div>
  );
};

const ShiftManager = ({ requests, events, staffList }) => {
  const [isGenerating, setIsGenerating] = useState(false);
  const [generated, setGenerated] = useState(false);
  const [shiftData, setShiftData] = useState([]);
  const [activeCell, setActiveCell] = useState(null);
  
  const daysInMonth = new Date(CURRENT_YEAR, CURRENT_MONTH, 0).getDate();
  const days = Array.from({ length: daysInMonth }, (_, i) => i + 1);

  const handleGenerate = () => {
    setIsGenerating(true);
    setGenerated(false);
    // Mock Async Call
    setTimeout(() => {
      const newShifts = [];
      staffList.forEach(staff => {
        days.forEach(day => {
          const dateStr = `${CURRENT_YEAR}-${String(CURRENT_MONTH).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
          const req = requests.find(r => r.staffId === staff.id && r.date === dateStr);
          newShifts.push({
            id: `${staff.id}-${day}`,
            date: dateStr,
            staffId: staff.id,
            shiftId: req ? 'S5' : (Math.random() > 0.8 ? 'S5' : 'S2') // Mock logic
          });
        });
      });
      setShiftData(newShifts);
      setIsGenerating(false);
      setGenerated(true);
    }, 1500);
  };

  const updateShift = (staffId, day, newShiftId) => {
    const dateStr = `${CURRENT_YEAR}-${String(CURRENT_MONTH).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    setShiftData(prev => {
      const existing = prev.find(s => s.staffId === staffId && s.date === dateStr);
      if (existing) {
        return prev.map(s => s.id === existing.id ? { ...s, shiftId: newShiftId } : s);
      }
      return [...prev, { id: `${staffId}-${day}`, staffId, date: dateStr, shiftId: newShiftId }];
    });
    setActiveCell(null);
  };

  return (
    <div className="space-y-6 h-full flex flex-col">
      <div className="flex justify-between items-center bg-white p-4 rounded-xl shadow-sm border border-slate-200">
        <div>
          <h2 className="text-2xl font-bold text-slate-800">{CURRENT_YEAR}年 {CURRENT_MONTH}月 シフト作成</h2>
          <p className="text-slate-500 text-sm">AIによる自動作成と手動調整</p>
        </div>
        <button onClick={handleGenerate} disabled={isGenerating} className={`flex items-center px-4 py-2 rounded-lg font-bold text-white shadow ${isGenerating ? 'bg-slate-400' : 'bg-teal-600'}`}>
          {isGenerating ? <RefreshCw className="w-5 h-5 mr-2 animate-spin" /> : <Play className="w-5 h-5 mr-2" />}
          {isGenerating ? '計算中...' : '自動作成'}
        </button>
      </div>
      
      {generated && (
        <div className="flex-1 overflow-auto bg-white rounded-xl shadow-sm border border-slate-200">
          <table className="w-full border-collapse text-sm">
            <thead className="bg-slate-50 sticky top-0 z-10">
              <tr>
                <th className="p-2 border sticky left-0 z-20 bg-slate-50 min-w-[120px]">職員名</th>
                {days.map(day => <th key={day} className="p-1 border min-w-[40px] text-center">{day}</th>)}
              </tr>
            </thead>
            <tbody>
              {staffList.map(staff => (
                <tr key={staff.id}>
                  <td className="p-2 border sticky left-0 z-10 bg-white font-medium">{staff.name}</td>
                  {days.map(day => {
                    const dateStr = `${CURRENT_YEAR}-${String(CURRENT_MONTH).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const shift = shiftData.find(s => s.staffId === staff.id && s.date === dateStr);
                    const meta = SHIFT_TYPES.find(s => s.id === shift?.shiftId);
                    const isActive = activeCell?.staffId === staff.id && activeCell?.day === day;
                    
                    return (
                      <td key={day} className="border text-center p-0 relative">
                        <button 
                          onClick={() => setActiveCell({ staffId: staff.id, day })}
                          className={`w-full h-10 text-xs font-bold ${meta?.color || 'bg-white'} ${meta?.textColor || ''}`}
                        >
                          {meta?.name.substring(0, 1)}
                        </button>
                        {isActive && (
                          <div className="absolute top-full left-0 z-50 bg-white border shadow-lg p-2 grid grid-cols-2 gap-1 min-w-[100px]">
                            {SHIFT_TYPES.map(s => (
                              <button key={s.id} onClick={(e) => { e.stopPropagation(); updateShift(staff.id, day, s.id); }} className={`p-1 text-xs ${s.color}`}>
                                {s.name}
                              </button>
                            ))}
                            <button onClick={(e) => { e.stopPropagation(); setActiveCell(null); }} className="col-span-2 text-xs bg-slate-100 p-1">閉じる</button>
                          </div>
                        )}
                      </td>
                    );
                  })}
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}
    </div>
  );
};

// --- Main App Component ---

const App = () => {
  const [currentUser, setCurrentUser] = useState(null);
  const [currentView, setCurrentView] = useState('LOGIN');
  
  // Data State
  const [requests, setRequests] = useState(INITIAL_REQUESTS);
  const [events, setEvents] = useState(MOCK_EVENTS);
  const [staffList, setStaffList] = useState(MOCK_STAFF);

  // Initial Data Load from GAS (Mock)
  useEffect(() => {
    // google.script.run が利用可能な場合（GAS環境下）
    if (window.google && window.google.script) {
      google.script.run.withSuccessHandler(setStaffList).getStaffList();
      google.script.run.withSuccessHandler(setEvents).getEvents();
    }
  }, []);

  const handleLogin = (user) => {
    setCurrentUser(user);
    setCurrentView(user.isAdmin ? 'MANAGER' : 'REQUEST');
  };

  const handleLogout = () => {
    setCurrentUser(null);
    setCurrentView('LOGIN');
  };

  if (!currentUser) {
    return <Login onLogin={handleLogin} staffList={staffList} />;
  }

  return (
    <Layout currentUser={currentUser} currentView={currentView} setView={setCurrentView} onLogout={handleLogout}>
      {currentView === 'REQUEST' && <ShiftRequestScreen currentUser={currentUser} events={events} existingRequests={requests} onSaveRequests={setRequests} />}
      {currentView === 'MANAGER' && <ShiftManager requests={requests} events={events} staffList={staffList} />}
      {currentView === 'STAFF' && <StaffManager staffList={staffList} onUpdateStaff={setStaffList} />}
      {currentView === 'EVENTS' && <EventManager events={events} onUpdateEvents={setEvents} />}
    </Layout>
  );
};

// Mount
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);

</script>